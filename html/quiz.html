<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taking Quiz - Quiznaut AI</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .quiz-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            min-height: 80vh;
        }

        .quiz-main {
            background: var(--panel);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .quiz-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            color: var(--text);
        }

        .quiz-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--muted);
            white-space: nowrap;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: var(--panel-2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .question-container {
            margin-bottom: 2rem;
        }

        .question-number {
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-item {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item.correct {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid #22c55e;
            border-radius: 12px;
        }

        .option-item.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 12px;
        }

        .option-item.selected {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid #3b82f6;
            border-radius: 12px;
        }

        .option-item.correct .option-label {
            color: #22c55e;
            font-weight: 600;
        }

        .option-item.incorrect .option-label {
            color: #ef4444;
            font-weight: 600;
        }

        .option-item.selected .option-label {
            color: #3b82f6;
            font-weight: 600;
        }

        .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #ef4444;
            text-align: center;
            margin: 1rem 0;
        }

        .explanation {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .explanation p {
            margin: 0;
            line-height: 1.6;
            color: var(--text);
        }

        .option-radio {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .option-label {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--panel-2);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .option-label:hover {
            border-color: var(--accent);
            background: rgba(245, 158, 11, 0.05);
        }

        .option-radio:checked + .option-label {
            border-color: var(--accent);
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .option-letter {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            background: var(--panel);
            border: 2px solid var(--border);
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--muted);
            margin-right: 1rem;
            transition: all 0.3s ease;
        }

        .option-radio:checked + .option-label .option-letter {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 1rem;
            color: var(--text);
        }

        /* Answer feedback styles */
        .option-item.correct .option-label {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .option-item.correct .option-letter {
            background: #2ecc71;
            border-color: #2ecc71;
            color: white;
        }

        .option-item.incorrect .option-label {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .option-item.incorrect .option-letter {
            background: #e74c3c;
            border-color: #e74c3c;
            color: white;
        }

        .option-item.selected:not(.correct) .option-label {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .option-item.selected:not(.correct) .option-letter {
            background: #e74c3c;
            border-color: #e74c3c;
            color: white;
        }

        .feedback-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--panel-2);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .feedback-icon {
            font-size: 1.2rem;
        }

        .feedback-title {
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .feedback-text {
            color: var(--text);
            line-height: 1.6;
            margin: 0 0 1rem 0;
        }

        .why-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .why-btn:hover {
            background: var(--accent-2);
            transform: translateY(-1px);
        }

        .explanation {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            display: none;
        }



        .quiz-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border);
            gap: 1rem;
        }

        .quiz-actions .nav-btn:first-child {
            margin-right: auto;
        }

        .quiz-actions .submit-btn {
            margin-left: auto;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            width: max-content;
            border: 2px solid var(--border);
            background: var(--panel-2);
            color: var(--text);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
            justify-content: center;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .nav-btn:hover:not(:disabled) {
            border-color: var(--accent);
            background: rgba(245, 158, 11, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.25);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            background: var(--panel);
            border-color: var(--border);
            color: var(--muted);
        }

        .nav-btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced button states */
        .nav-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
        }

        /* Enhanced Previous button specific styling */
        .nav-btn:not(:disabled)::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-btn:not(:disabled):hover::before {
            left: 100%;
        }

        .submit-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3);
        }

        .submit-btn {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, #2ecc71, #34d199);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            font-size: 1rem;
            min-width: 140px;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.2);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(46, 204, 113, 0.3);
        }

        /* Leaderboard sidebar */
        .leaderboard-sidebar {
            background: var(--panel);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .sidebar-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
            color: var(--text);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--panel-2);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .player-avatar {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .player-details h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text);
        }

        .player-details p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--panel-2);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            transform: translateX(2px);
        }

        .rank {
            font-weight: 700;
            color: var(--accent);
            min-width: 1.5rem;
            font-size: 0.9rem;
        }

        .rank.gold { color: #ffd700; }
        .rank.silver { color: #c0c0c0; }
        .rank.bronze { color: #cd7f32; }

        .player-name {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 500;
        }

        .score-badge {
            padding: 0.25rem 0.5rem;
            background: linear-gradient(135deg, #2ecc71, #34d199);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .current-player {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--accent);
        }

        @media (max-width: 1024px) {
            .quiz-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .leaderboard-sidebar {
                position: static;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .quiz-container {
                padding: 1rem;
            }

            .quiz-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .quiz-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-btn, .submit-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
  </head>
  <body>
    <div class="container">
    <header class="site-header">
      <div class="header-inner">
        <a class="brand" href="/" aria-label="Quiznaut AI Home">
          <img class="brand-logo" src="/QUIZNAUT%20AI%20Logo.png" alt="" decoding="async"/>
          <span class="brand-name">Quiznaut AI</span>
        </a>
        <nav class="nav-actions" aria-label="Primary">
          <a class="link" href="/create.html">Create Quiz</a>
          <a class="link" href="/#quizzes">Available Quizzes</a>
          <a class="link" href="/#how">How it Works</a>
        </nav>
      </div>
    </header>

    <main>
            <div class="quiz-container">
                <div class="quiz-main">
            <div class="quiz-header">
                        <h1 class="quiz-title" id="quizTitle">Loading Quiz...</h1>
                        <div class="quiz-progress">
                            <span class="progress-text" id="progressText">Question 1 of 5</span>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 20%"></div>
                            </div>
                        </div>
            </div>

                    <div class="question-container" id="questionContainer">
                        <div class="question-number" id="questionNumber">Question 1</div>
                        <div class="question-text" id="questionText">Loading question...</div>
                        
                        <div class="options-container" id="optionsContainer">
                            <!-- Options will be populated here -->
                        </div>

                        <div class="feedback-section" id="feedbackSection" style="display: none;">
                            <div class="feedback-header">
                                <span class="feedback-icon" id="feedbackIcon">‚úÖ</span>
                                <h3 class="feedback-title" id="feedbackTitle">Correct!</h3>
                            </div>
                            <p class="feedback-text" id="feedbackText">Great job! You got this question right.</p>
                            <button class="why-btn" id="whyBtn" onclick="toggleExplanation()">ü§î Why is this correct?</button>
                            <div class="explanation" id="explanation">
                                <p>Loading AI explanation...</p>
                            </div>
                        </div>
                    </div>

                    <div class="quiz-actions">
                        <button class="nav-btn" id="prevBtn" onclick="previousQuestion()" disabled>
                            ‚Üê Previous
                        </button>
                        <button class="nav-btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">
                            Next ‚Üí
                        </button>
                        <button class="submit-btn" id="submitBtn" onclick="submitQuiz()" style="display: none;">
                            üéØ Submit Quiz
                        </button>
                    </div>
                </div>

                <div class="leaderboard-sidebar">
                    <div class="sidebar-header">
                        <span>üèÜ</span>
                        <h2 class="sidebar-title">Leaderboard</h2>
              </div>

                    <div class="player-info" id="playerInfo">
                        <div class="player-avatar" id="playerAvatar">U</div>
                        <div class="player-details">
                            <h3 id="playerName">Player</h3>
                            <p id="playerScore">0/0 correct</p>
              </div>
            </div>

                    <div class="leaderboard-list" id="leaderboardList">
                        <!-- Leaderboard will be populated here -->
                    </div>
              </div>
            </div>
        </main>
    </div>

    <!-- Supabase SDK must load before our modules that create/use the client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/env.js" type="module"></script>
    <script type="module">
        import { supabaseClient } from '/js/supabaseClient.js';

        // Quiz state
        let quizData = null;
        let currentQuestionIndex = 0;
        let answers = [];
        let playerName = '';
        let leaderboardData = [];

        // Get quiz ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get('id');

        if (!quizId) {
            alert('No quiz ID provided!');
                            window.location.href = '/';
        }

        // Get player name from session storage
        playerName = sessionStorage.getItem('playerName');
        if (!playerName) {
            alert('No player name found! Please start from the quiz start page.');
            window.location.href = `quiz-start.html?id=${quizId}`;
        }

        // Initialize quiz
        async function initQuiz() {
            try {
                console.log('Initializing quiz with ID:', quizId);
                console.log('Player name:', playerName);
                
                // Load quiz data
                const { data, error } = await supabaseClient
                    .from('quizzes')
                    .select('*')
                    .eq('id', quizId)
                    .single();

                if (error) throw error;

                console.log('Quiz data loaded:', data);
                console.log('Quiz title:', data.title);
                console.log('Quiz questions count:', data.questions ? data.questions.length : 'NO QUESTIONS ARRAY');
                console.log('Questions array:', data.questions);
                
                quizData = data;
                answers = new Array(quizData.questions.length).fill(null);
                
                // Validate quiz data
                if (!quizData.questions || !Array.isArray(quizData.questions) || quizData.questions.length === 0) {
                    throw new Error('Quiz has no questions or invalid question format');
                }
                
                // Validate each question
                quizData.questions.forEach((q, index) => {
                    console.log(`Question ${index + 1}:`, {
                        text: q.text,
                        options: q.options,
                        correctIndex: q.correctIndex,
                        optionsLength: q.options ? q.options.length : 'NO OPTIONS'
                    });
                    
                    if (!q.text || !q.options || !Array.isArray(q.options) || q.options.length < 2) {
                        throw new Error(`Question ${index + 1} is invalid: missing text, options, or insufficient options`);
                    }
                    
                    if (q.correctIndex === undefined || q.correctIndex < 0 || q.correctIndex >= q.options.length) {
                        throw new Error(`Question ${index + 1} has invalid correctIndex: ${q.correctIndex}`);
                    }
                });
                
                console.log('Questions loaded:', quizData.questions.length);
                console.log('Answers array initialized:', answers);
                
                displayQuizInfo();
                displayQuestion();
                loadLeaderboard();
                updatePlayerInfo();
            } catch (error) {
                console.error('Error loading quiz:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                
                // Show error on page
                document.getElementById('questionText').textContent = `Error loading quiz: ${error.message}`;
                document.getElementById('optionsContainer').innerHTML = `
                    <div class="error">
                        <p><strong>Failed to load quiz:</strong> ${error.message}</p>
                        <p>Please check the URL or try refreshing the page.</p>
                        <button onclick="location.reload()" style="background: var(--accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
                            üîÑ Refresh Page
                        </button>
                    </div>
                `;
            }
        }

        function displayQuizInfo() {
            document.getElementById('quizTitle').textContent = quizData.title;
            document.getElementById('playerName').textContent = playerName;
            document.getElementById('playerAvatar').textContent = playerName.charAt(0).toUpperCase();
        }

        function displayQuestion() {
            console.log('Displaying question:', currentQuestionIndex);
            
            if (!quizData || !quizData.questions || !quizData.questions[currentQuestionIndex]) {
                console.error('No question data available for index:', currentQuestionIndex);
                return;
            }
            
            const question = quizData.questions[currentQuestionIndex];
            const questionNumber = currentQuestionIndex + 1;
            const totalQuestions = quizData.questions.length;

            console.log('Question data:', question);

            // Update progress
            document.getElementById('questionNumber').textContent = `Question ${questionNumber}`;
            document.getElementById('questionText').textContent = question.text;
            document.getElementById('progressText').textContent = `Question ${questionNumber} of ${totalQuestions}`;
            document.getElementById('progressFill').style.width = `${(questionNumber / totalQuestions) * 100}%`;

            // Generate options
            const optionsContainer = document.getElementById('optionsContainer');
            if (!question.options || !Array.isArray(question.options)) {
                console.error('Invalid options for question:', question);
                optionsContainer.innerHTML = '<p class="error">Error: No options available for this question.</p>';
                return;
            }
            
            optionsContainer.innerHTML = question.options.map((option, index) => `
                <div class="option-item" data-index="${index}">
                    <input type="radio" class="option-radio" name="question${currentQuestionIndex}" id="option${index}" value="${index}">
                    <label class="option-label" for="option${index}">
                        <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                        <span class="option-text">${option}</span>
                    </label>
                </div>
            `).join('');

            // Add event listeners and check if question was already answered
            optionsContainer.querySelectorAll('.option-radio').forEach(radio => {
                radio.addEventListener('change', handleAnswerSelect);
                
                // If this question was already answered, disable all options
                if (answers[currentQuestionIndex] !== null) {
                    radio.disabled = true;
                    radio.parentElement.style.pointerEvents = 'none';
                    
                    // If this was the selected answer, mark it as selected
                    if (parseInt(radio.value) === answers[currentQuestionIndex]) {
                        radio.checked = true;
                        radio.parentElement.classList.add('selected');
                    }
                }
            });
            
            // If question was already answered, show feedback
            if (answers[currentQuestionIndex] !== null) {
                showFeedback(answers[currentQuestionIndex]);
            }

            // Update navigation buttons
            updateNavigationButtons();
            
            // Hide feedback section
            document.getElementById('feedbackSection').style.display = 'none';
            
            console.log('Question displayed successfully');
        }

        function handleAnswerSelect(event) {
            const selectedIndex = parseInt(event.target.value);
            answers[currentQuestionIndex] = selectedIndex;
            
            // Disable all radio buttons to prevent changes
            const allRadios = document.querySelectorAll('.option-radio');
            allRadios.forEach(radio => {
                radio.disabled = true;
                radio.parentElement.style.pointerEvents = 'none';
            });
            
            // Show feedback
            showFeedback(selectedIndex);
            
            // Update navigation
            updateNavigationButtons();
        }

        function showFeedback(selectedIndex) {
            const question = quizData.questions[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correctIndex;
            
            console.log('Showing feedback for answer:', selectedIndex, 'Correct:', question.correctIndex, 'Is correct:', isCorrect);
            
            // Update option styling
            const options = document.querySelectorAll('.option-item');
            options.forEach((option, index) => {
                option.classList.remove('correct', 'incorrect', 'selected');
                
                if (index === question.correctIndex) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && !isCorrect) {
                    option.classList.add('incorrect', 'selected');
                } else if (index === selectedIndex) {
                    option.classList.add('selected');
                }
            });

            // Show feedback section
            const feedbackSection = document.getElementById('feedbackSection');
            const feedbackIcon = document.getElementById('feedbackIcon');
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackText = document.getElementById('feedbackText');
            const whyBtn = document.getElementById('whyBtn');

            feedbackSection.style.display = 'block';
            
            if (isCorrect) {
                feedbackIcon.textContent = '‚úÖ';
                feedbackTitle.textContent = 'Correct!';
                feedbackText.textContent = `Great job! You selected "${question.options[selectedIndex]}" which is the right answer.`;
                whyBtn.textContent = 'ü§î Why is this correct?';
            } else {
                feedbackIcon.textContent = '‚ùå';
                feedbackTitle.textContent = 'Incorrect';
                feedbackText.textContent = `You selected "${question.options[selectedIndex]}" but the correct answer is "${question.options[question.correctIndex]}".`;
                whyBtn.textContent = 'ü§î Why is this wrong?';
            }

            // Hide explanation initially
            document.getElementById('explanation').style.display = 'none';
            
            // Update player score display
            updatePlayerInfo();
        }



        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === quizData.questions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'inline-flex';
                submitBtn.style.display = 'none';
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizData.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        async function submitQuiz() {
            // Calculate score
            let correctAnswers = 0;
            const totalQuestions = quizData.questions.length;
            
            answers.forEach((answer, index) => {
                if (answer === quizData.questions[index].correctIndex) {
                    correctAnswers++;
                }
            });
            
            const score = Math.round((correctAnswers / totalQuestions) * 100);
            
            console.log('Quiz completed! Score:', score, 'Correct:', correctAnswers, 'Total:', totalQuestions);
            
            // Show final score to user before redirecting
            const finalScoreMsg = `Quiz completed! You got ${correctAnswers} out of ${totalQuestions} questions correct (${score}%). Redirecting to results...`;
            alert(finalScoreMsg);
            
            // Save score to database
            try {
                console.log('Submitting score:', {
                    quiz_id: quizId,
                    player_name: playerName,
                    score: score,
                    correct_answers: correctAnswers,
                    total_questions: totalQuestions,
                    answers: answers
                });
                
                const { data, error } = await supabaseClient
                    .from('quiz_scores')
                    .insert({
                        quiz_id: quizId,
                        player_name: playerName,
                        score: score,
                        correct_answers: correctAnswers,
                        total_questions: totalQuestions,
                        answers: answers
                    })
                    .select();

                if (error) {
                    console.error('Supabase insert error:', error);
                    throw error;
                }
                
                console.log('Score saved successfully:', data);
                
                // Redirect to results page
                window.location.href = `quiz-results.html?id=${quizId}&score=${score}&correct=${correctAnswers}&total=${totalQuestions}`;
            } catch (error) {
                console.error('Error saving score:', error);
                
                // Provide more specific error information
                if (error.code === '23505') {
                    alert('A score for this player already exists. Redirecting to results...');
                } else if (error.code === '23503') {
                    alert('Quiz not found. Please check the quiz ID.');
                } else {
                    alert(`Failed to save your score: ${error.message}. Redirecting to results anyway...`);
                }
                
                // Redirect to results page even if save fails
                window.location.href = `quiz-results.html?id=${quizId}&score=${score}&correct=${correctAnswers}&total=${totalQuestions}`;
            }
        }

        async function loadLeaderboard() {
            try {
                const { data, error } = await supabaseClient
                    .from('quiz_scores')
                    .select('*')
                    .eq('quiz_id', quizId)
                    .order('score', { ascending: false })
                    .limit(10);

                if (error) throw error;

                leaderboardData = data || [];
                displayLeaderboard();
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function displayLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (leaderboardData.length === 0) {
                leaderboardList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--muted);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üèÜ</div>
                        <p>No scores yet. Be the first!</p>
        </div>
                `;
                return;
            }

            leaderboardList.innerHTML = leaderboardData.map((score, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '#' + (index + 1);
                const isCurrentPlayer = score.player_name === playerName;
                
                return `
                    <div class="leaderboard-item ${isCurrentPlayer ? 'current-player' : ''}">
                        <div class="rank ${rankClass}">${rankIcon}</div>
                        <div class="player-name">${score.player_name}</div>
                        <div class="score-badge">${score.score}%</div>
      </div>
                `;
            }).join('');
        }

        function updatePlayerInfo() {
            const correctAnswers = answers.filter((answer, index) => 
                answer === quizData.questions[index].correctIndex
            ).length;
            
            document.getElementById('playerScore').textContent = `${correctAnswers}/${answers.filter(a => a !== null).length} correct`;
        }

        // Toggle explanation visibility and generate AI explanation
        async function toggleExplanation() {
            const explanation = document.getElementById('explanation');
            const whyBtn = document.getElementById('whyBtn');
            
            if (explanation.style.display === 'none' || explanation.style.display === '') {
                explanation.style.display = 'block';
                whyBtn.textContent = 'ü§î Hide explanation';
                
                // Always generate fresh AI explanation when showing explanation
                await generateAIExplanation();
            } else {
                explanation.style.display = 'none';
                // Restore the original button text based on whether the answer was correct or not
                const question = quizData.questions[currentQuestionIndex];
                const userAnswer = answers[currentQuestionIndex];
                const isCorrect = userAnswer === question.correctIndex;
                whyBtn.textContent = isCorrect ? 'ü§î Why is this correct?' : 'ü§î Why is this wrong?';
            }
        }

        // Generate AI explanation using Gemini
        async function generateAIExplanation() {
            const explanation = document.getElementById('explanation');
            const whyBtn = document.getElementById('whyBtn');
            
            // Show loading state
            whyBtn.textContent = 'ü§î Generating explanation...';
            whyBtn.disabled = true;
            
            try {
                const question = quizData.questions[currentQuestionIndex];
                const correctAnswer = question.options[question.correctIndex];
                const userAnswer = answers[currentQuestionIndex];
                const isCorrect = userAnswer === question.correctIndex;
                
                // Create prompt for Gemini - requesting 3-line explanation
                const prompt = `Question: "${question.text}"
                
                Correct Answer: "${correctAnswer}"
                User's Answer: "${question.options[userAnswer] || 'No answer selected'}"
                User was: ${isCorrect ? 'CORRECT' : 'INCORRECT'}
                
                Please provide a clear, educational explanation in exactly 3 lines:
                Line 1: Explain why the correct answer is right
                Line 2: If user was wrong, explain why their choice was incorrect
                Line 3: Provide a learning point or additional context
                
                Keep each line concise but informative. Format as plain text without any markdown.`;
                
                console.log('Generating AI explanation with prompt:', prompt);
                
                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${window.GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Gemini API error:', response.status, errorText);
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Gemini API response:', data);
                
                const aiExplanation = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiExplanation) {
                    // Format the explanation to ensure it's 3 lines
                    const lines = aiExplanation.split('\n').filter(line => line.trim()).slice(0, 3);
                    const formattedExplanation = lines.join('\n');
                    
                    explanation.querySelector('p').innerHTML = formattedExplanation.replace(/\n/g, '<br>');
                    console.log('AI explanation set:', formattedExplanation);
                } else {
                    throw new Error('No explanation text in API response');
                }
                
            } catch (error) {
                console.error('AI explanation generation failed:', error);
                
                // Fallback to simple explanation
                const question = quizData.questions[currentQuestionIndex];
                const correctAnswer = question.options[question.correctIndex];
                const userAnswer = answers[currentQuestionIndex];
                const isCorrect = userAnswer === question.correctIndex;
                
                let fallbackExplanation = `The correct answer is "${correctAnswer}" because it directly addresses the question.`;
                
                if (!isCorrect) {
                    fallbackExplanation += ` Your answer "${question.options[userAnswer]}" was incorrect because it doesn't match the expected response.`;
                }
                
                fallbackExplanation += ` This question tests your understanding of the core concepts.`;
                
                explanation.querySelector('p').innerHTML = fallbackExplanation.replace(/\n/g, '<br>');
                
                // Show error message to user
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem; font-style: italic;';
                errorMsg.textContent = 'AI explanation unavailable. Showing fallback explanation.';
                explanation.appendChild(errorMsg);
            } finally {
                // Reset button state
                whyBtn.textContent = 'ü§î Hide explanation';
                whyBtn.disabled = false;
            }
        }

        // Make functions globally accessible for onclick handlers
        window.previousQuestion = previousQuestion;
        window.nextQuestion = nextQuestion;
        window.submitQuiz = submitQuiz;
        window.toggleExplanation = toggleExplanation;

        // Initialize quiz on page load
        initQuiz();
        
        // Add fallback test display in case quiz fails to load
        setTimeout(() => {
            if (!quizData || !quizData.questions) {
                console.error('Quiz failed to load after timeout');
                document.getElementById('questionText').textContent = 'Error: Quiz failed to load. Please refresh the page or check the quiz ID.';
                document.getElementById('optionsContainer').innerHTML = `
                    <div class="error">
                        <p>Quiz data could not be loaded. This might be due to:</p>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>Invalid quiz ID in the URL</li>
                            <li>Database connection issues</li>
                            <li>Quiz has been deleted</li>
                        </ul>
                        <button onclick="location.reload()" style="background: var(--accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
                            üîÑ Refresh Page
                        </button>
                    </div>
                `;
            }
        }, 5000); // 5 second timeout
    </script>
  </body>
  </html>


